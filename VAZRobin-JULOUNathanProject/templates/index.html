<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revieweur de Code IA</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            color: #1f2937;
            margin: 0;
            padding: 40px 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 15px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        .nav-links {
            display: flex;
            gap: 20px;
        }
        .nav-links a {
            text-decoration: none;
            color: #2563eb;
            font-weight: bold;
            transition: color 0.2s;
        }
        .nav-links a:hover {
            color: #1d4ed8;
        }
        .nav-links a.logout {
            color: #dc2626;
        }
        .nav-links a.logout:hover {
            color: #b91c1c;
        }

        header {
            text-align: center;
            margin-bottom: 50px;
        }
        
        h1 {
            color: #1e3a8a;
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
        }
        
        header p {
            color: #4b5563;
            font-size: 1.1em;
        }

        .card {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            border: 1px solid #f3f4f6;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }

        .level-selector {
            margin-bottom: 25px;
            background-color: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
        }

        .radio-option {
            font-weight: normal;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
        }

        .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: #374151;
        }

        input[type="text"], input[type="number"] {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(to right, #2563eb, #1d4ed8);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(37, 99, 235, 0.3);
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .steps-container {
            display: flex;
            gap: 20px;
            text-align: center;
            margin-top: 20px;
        }

        .step {
            flex: 1;
            padding: 20px;
            background-color: #f8fafc;
            border-radius: 8px;
            border: 1px dashed #cbd5e1;
        }

        .step-icon { font-size: 2em; margin-bottom: 10px; }
        .step h3 { margin: 0 0 10px 0; color: #334155; font-size: 1.1em; }
        .step p { margin: 0; font-size: 0.9em; color: #64748b; }

        .hidden { display: none !important; }
        
        #loading { text-align: center; padding: 40px 0; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .result-card { border-top: 6px solid #10b981; }
        #aiResponse h3 { color: #1f2937; border-bottom: 2px solid #f3f4f6; padding-bottom: 8px; margin-top: 30px; }
        #aiResponse pre {
            background-color: #1e293b;
            color: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
        }
        #aiResponse code {
            font-family: 'Courier New', Courier, monospace;
            background-color: #e2e8f0;
            color: #b91c1c;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        #aiResponse pre code { background-color: transparent; color: inherit; padding: 0; }
    </style>
</head>
<body>

    <div class="container">
        <nav class="navbar">
            <div><strong>ü§ñ Revieweur IA</strong> | Bonjour{% if username %}, {{ username }}{% endif %} !</div>
            <div class="nav-links">
                <a href="/">Nouvelle Analyse</a>
                <a href="/historique">Mon Historique</a>
                <a href="/logout" class="logout">D√©connexion</a>
            </div>
        </nav>

        <header>
            <h1>ü§ñ Revieweur de Code IA</h1>
            <p>Analysez vos Pull Requests GitHub gr√¢ce √† l'Intelligence Artificielle.</p>
        </header>

        <div class="card">
            <div class="form-row">
                <div class="form-group">
                    <label for="owner">üè¢ Propri√©taire (ex: pallets)</label>
                    <input type="text" id="owner" placeholder="pallets">
                </div>
                <div class="form-group">
                    <label for="repo">üì¶ D√©p√¥t (ex: flask)</label>
                    <input type="text" id="repo" placeholder="flask">
                </div>
                <div class="form-group">
                    <label for="pr">üî¢ Num√©ro de PR (ex: 5000)</label>
                    <input type="number" id="pr" placeholder="5000">
                </div>
            </div>

            <div class="level-selector-container">
                <label class="section-label" style="font-size: 1.2rem; font-weight: 600; margin-bottom: 12px; display: block;">üéì Cible de la revue :</label>
                <div class="radio-group-modern" style="display: flex; gap: 24px; justify-content: center;">
                    <label class="radio-card junior-card" style="position: relative; background: linear-gradient(135deg, #e0ffe7 60%, #b2f7c6 100%); border-radius: 16px; box-shadow: 0 2px 8px rgba(34, 139, 34, 0.08); padding: 18px 32px; cursor: pointer; transition: box-shadow 0.2s, border 0.2s; border: 2px solid transparent; display: flex; align-items: center; min-width: 220px;">
                        <input type="radio" name="level" value="junior" id="level-junior" style="display: none;">
                        <span class="custom-radio" style="margin-right: 18px;"></span>
                        <div class="card-content" style="display: flex; align-items: center; gap: 16px;">
                            <span class="card-icon" style="font-size: 2.2rem;">üå±</span>
                            <div class="card-text" style="display: flex; flex-direction: column;">
                                <strong style="font-size: 1.1rem; color: #228B22;">P√©dagogique</strong>
                                <span style="font-size: 0.95rem; color: #228B22; opacity: 0.8;">(Pour Junior)</span>
                            </div>
                        </div>
                    </label>
                    <label class="radio-card senior-card" style="position: relative; background: linear-gradient(135deg, #e6f0ff 60%, #b3d1ff 100%); border-radius: 16px; box-shadow: 0 2px 8px rgba(30, 144, 255, 0.08); padding: 18px 32px; cursor: pointer; transition: box-shadow 0.2s, border 0.2s; border: 2px solid transparent; display: flex; align-items: center; min-width: 220px;">
                        <input type="radio" name="level" value="senior" id="level-senior" checked style="display: none;">
                        <span class="custom-radio" style="margin-right: 18px;"></span>
                        <div class="card-content" style="display: flex; align-items: center; gap: 16px;">
                            <span class="card-icon" style="font-size: 2.2rem;">üöÄ</span>
                            <div class="card-text" style="display: flex; flex-direction: column;">
                                <strong style="font-size: 1.1rem; color: #1e90ff;">Direct & Technique</strong>
                                <span style="font-size: 0.95rem; color: #1e90ff; opacity: 0.8;">(Pour Senior)</span>
                            </div>
                        </div>
                    </label>
                </div>
                <style>
                .radio-card { position: relative; }
                .radio-card input[type="radio"]:checked + .custom-radio { border: 2px solid #228B22; background: #fff; }
                .senior-card input[type="radio"]:checked + .custom-radio { border: 2px solid #1e90ff; background: #fff; }
                .custom-radio {
                    width: 24px; height: 24px; border-radius: 50%; border: 2px solid #bbb;
                    background: #f5f5f5; display: inline-block; position: relative;
                    transition: border 0.2s, background 0.2s;
                }
                .radio-card input[type="radio"]:checked + .custom-radio::after {
                    content: ""; display: block; width: 12px; height: 12px; border-radius: 50%;
                    background: #228B22; position: absolute; top: 50%; left: 50%;
                    transform: translate(-50%, -50%); transition: background 0.2s;
                }
                .senior-card input[type="radio"]:checked + .custom-radio::after { background: #1e90ff; }
                .radio-card:hover .custom-radio { border-color: #228B22; }
                .senior-card:hover .custom-radio { border-color: #1e90ff; }
                .how-it-works-block { margin-bottom: 40px !important; }
                .launch-ia-btn { margin-top: 24px !important; }
                </style>
                <script>
                document.querySelectorAll('.radio-card').forEach(function(card) {
                    card.addEventListener('click', function(e) {
                        let radio = card.querySelector('input[type="radio"]');
                        radio.checked = true;
                        document.querySelectorAll('.radio-card').forEach(function(c) { c.classList.remove('selected'); });
                        card.classList.add('selected');
                    });
                });
                </script>
            </div>

            <button id="analyzeBtn" onclick="startAnalysis()">‚ú® Lancer l'analyse IA</button>
        </div>

        <div style="height: 32px;"></div>

        <div id="infoSection" class="card">
            <h2 style="text-align: center; color: #475569; margin-top: 0;">Comment √ßa marche ?</h2>
            <div class="steps-container">
                <div class="step">
                    <div class="step-icon">üì°</div>
                    <h3>1. Extraction</h3>
                    <p>Nous r√©cup√©rons le code source modifi√© directement via l'API GitHub.</p>
                </div>
                <div class="step">
                    <div class="step-icon">üß†</div>
                    <h3>2. Analyse IA</h3>
                    <p>Le mod√®le inspecte les failles, les bugs et les conventions.</p>
                </div>
                <div class="step">
                    <div class="step-icon">üìù</div>
                    <h3>3. Rapport</h3>
                    <p>Un compte-rendu clair et d√©taill√© est g√©n√©r√© pour faciliter la revue humaine.</p>
                </div>
            </div>
        </div>

        <div id="loading" class="hidden">
            <div class="spinner"></div>
            <h3 style="color: #2563eb;">Analyse en cours...</h3>
            <p style="color: #64748b;">L'IA lit le code et adapte ses conseils √† votre profil.</p>
        </div>

        <div id="resultContainer" class="card result-card hidden">
            <h2 style="color: #10b981; margin-top: 0;">‚úÖ Rapport d'analyse termin√©</h2>
            <div id="aiResponse"></div> 

            <div id="chatContainer" class="hidden" style="margin-top: 40px; border-top: 2px solid #e2e8f0; padding-top: 20px;">
                <h3 style="color: #1e3a8a;">üí¨ Discutez avec l'IA de ce code</h3>
                
                <div id="chatMessages" style="height: 300px; overflow-y: auto; background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 15px;">
                    </div>
                
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chatInput" placeholder="Demandez d'expliquer une fonction, de r√©√©crire un bloc..." style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1;" onkeypress="if(event.key === 'Enter') sendChatMessage()">
                    <button onclick="sendChatMessage()" style="width: auto; padding: 12px 25px; background: #10b981; margin: 0;">Envoyer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // M√©moire du navigateur pour le chat
        let currentChatHistory = [];
        
        async function startAnalysis() {
            const owner = document.getElementById('owner').value.trim();
            const repo = document.getElementById('repo').value.trim();
            const pr = document.getElementById('pr').value.trim();
            const selectedLevel = document.querySelector('input[name="level"]:checked').value;
            
            const btn = document.getElementById('analyzeBtn');
            const loadingZone = document.getElementById('loading');
            const resultZone = document.getElementById('resultContainer');
            const infoZone = document.getElementById('infoSection');
            const responseDiv = document.getElementById('aiResponse');

            if (!owner || !repo || !pr) {
                alert("Veuillez remplir tous les champs.");
                return;
            }

            infoZone.classList.add('hidden');
            loadingZone.classList.remove('hidden');
            resultZone.classList.add('hidden');
            document.getElementById('chatContainer').classList.add('hidden'); 
            btn.disabled = true;
            btn.innerText = "‚è≥ Analyse en cours...";

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        owner: owner, 
                        repo: repo, 
                        pr: pr,
                        level: selectedLevel 
                    })
                });

                const data = await response.json();
                loadingZone.classList.add('hidden');
                
                if (data.status === 'success') {
                    responseDiv.innerHTML = marked.parse(data.result);
                    resultZone.classList.remove('hidden');

                    currentChatHistory = [
                        { role: "system", content: "Tu es un expert en revue de code. Utilise le Markdown pour r√©pondre." },
                        { role: "user", content: "Voici le code √† analyser :\n```diff\n" + data.diff + "\n```" },
                        { role: "assistant", content: data.result }
                    ];
                    
                    document.getElementById('chatContainer').classList.remove('hidden');
                    document.getElementById('chatMessages').innerHTML = '<div style="text-align: center; color: #64748b; font-size: 0.9em;">D√©but de la conversation</div>';

                } else {
                    alert("Erreur: " + data.message);
                    infoZone.classList.remove('hidden');
                }
            } catch (error) {
                loadingZone.classList.add('hidden');
                infoZone.classList.remove('hidden');
                alert("Une erreur de connexion est survenue avec le serveur.");
            } finally {
                btn.disabled = false;
                btn.innerText = "‚ú® Lancer l'analyse IA";
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            const chatMessagesDiv = document.getElementById('chatMessages');
            
            chatMessagesDiv.innerHTML += `
                <div style="align-self: flex-end; background: #2563eb; color: white; padding: 10px 15px; border-radius: 15px 15px 0 15px; max-width: 80%;">
                    ${message}
                </div>`;
            input.value = '';

            currentChatHistory.push({ role: "user", content: message });

            const loadingId = "loading-" + Date.now();
            chatMessagesDiv.innerHTML += `
                <div id="${loadingId}" style="align-self: flex-start; background: #e2e8f0; color: #1e293b; padding: 10px 15px; border-radius: 15px 15px 15px 0;">
                    <em>L'IA r√©fl√©chit...</em>
                </div>`;
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: currentChatHistory })
                });
                
                const data = await response.json();
                document.getElementById(loadingId).remove();

                if (data.status === 'success') {
                    currentChatHistory.push({ role: "assistant", content: data.reply });
                    
                    chatMessagesDiv.innerHTML += `
                        <div style="align-self: flex-start; background: white; border: 1px solid #e2e8f0; color: #1e293b; padding: 15px; border-radius: 15px 15px 15px 0; max-width: 85%; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            ${marked.parse(data.reply)}
                        </div>`;
                } else {
                    alert("Erreur: " + data.message);
                }
            } catch (e) {
                document.getElementById(loadingId).remove();
                alert("Erreur lors de l'envoi du message.");
            }
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }
    </script>
</body>
</html>